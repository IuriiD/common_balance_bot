
{
  'originalRequest': {
    'source': 'telegram',
    'data': {
      'callback_query': {
        'from': {
          'last_name': 'D.',
          'first_name': 'Iurii',
          'language_code': 'ru-RU',
          'is_bot': False,
          'id': 178180819
        },
        'message': {
          'date': 1519933138,
          'entities': [
            {
              'type': 'bold',
              'length': 10,
              'offset': 0
            }
          ],
          'from': {
            'username': 'YetAnotherTestChatBot',
            'id': 452144171,
            'is_bot': True,
            'first_name': 'TestTestTestBot'
          },
          'text': "Hi, Iurii!\nI'm a CommonBalanceBot - here to help you with tracking transactions with your friends.\nTo start you need a log. Should I create one for you?",
          'message_id': 589,
          'chat': {
            'id': 178180819,
            'last_name': 'D.',
            'type': 'private',
            'first_name': 'Iurii'
          }
        },
        'id': '765280791023790620',
        'data': 'Create log',
        'chat_instance': '-8728995663043026465'
      },
      'update_id': 686221134
    }
  },
  'timestamp': '2018-03-01T19:39:01.592Z',
  'lang': 'en',
  'sessionId': '82821da0-d1ef-4caf-8db4-f3602b989e8d',
  'status': {
    'errorType': 'success',
    'code': 200,
    'webhookTimedOut': False
  },
  'id': '91a324b3-403a-40a0-9aa4-b4a4c1d15de9',
  'result': {
    'actionIncomplete': False,
    'source': 'agent',
    'speech': '',
    'action': 'commonbalancebot-create_log',
    'resolvedQuery': 'Create log',
    'fulfillment': {
      'messages': [
        {
          'speech': '', 'type': 0
        }
      ],
      'speech': ''
    },
    'metadata': {
      'webhookUsed': 'true',
      'webhookForSlotFillingUsed': 'false',
      'intentId': 'ec5eb6ae-7785-44fb-9165-67d87d1c509c',
      'intentName': 'create_log'
    },
    'parameters': {},
    'score': 1.0,
    'contexts': [
      {
        'name': 'cookie',
        'lifespan': 19,
        'parameters': {
          'welcomed.original': '',
          'welcomed': 'yes'
        }
      }
    ]
  }
}



{
  'transactions': [
    {
      'total_balance': {
        'Tim': 0, 'Ann': 0, 'Dan': 0
      },
      'timestamp': 'today',
      'amount': 0,
      'who_paid': '',
      'who_received': 'all',
      'transaction_balance': {},
      'transaction_number': 0
    },
    {
      'total_balance': {
        'Tim': -66.67, 'Ann': -66.67, 'Dan': 133.33
      },
      'timestamp': '2018-02-22T09:01:10.433Z',
      'amount': 200,
      'who_paid': 'Dan',
      'who_received': 'all',
      'transaction_balance': {
        'Tim': -66.66666666666667, 'Ann': -66.66666666666667, 'Dan': 133.33333333333331
      },
      'transaction_number': 2
    }
  ],
  'users': ['Tim', 'Dan', 'Ann']
}

{
'transactions': [
  {
    'transaction_balance': {},
    'total_balance': {
      'Ann': 0,
      'Tim': 0,
      'Dan': 0
    },
    'who_paid': '',
    'who_received': 'all',
    'amount': 0,
    'timestamp': 'today',
    'transaction_number': 0
  },
  {
    'transaction_balance': {
      'Ann': -179.33333333333334,
      'Tim': 358.66666666666663,
      'Dan': -179.33333333333334
    },
    'total_balance': {
      'Ann': -179.33,
      'Tim': 358.67,
      'Dan': -179.33
    },
    'who_paid': 'Tim',
    'who_received': 'all',
    'amount': 538.0,
    'timestamp': '2018-02-23T10:24:59.404Z',
    'transaction_number': 1
  },
  {
    'transaction_balance': {
      'Ann': -166.66666666666666,
      'Tim': -166.66666666666666,
      'Dan': 333.33333333333337
    },
    'total_balance': {
      'Ann': -346.0,
      'Tim': 192.0,
      'Dan': 154.0
    },
    'who_paid': 'Dan',
    'who_received': 'all',
    'amount': 500.0,
    'timestamp': '2018-02-23T10:25:13.811Z',
    'transaction_number': 2
  },
  {
    ...
  }
  },
  'users': ['Tim', 'Dan', 'Ann']
}

    '''
        Report - variant 1 - problems if many users, in telegram etc. hard to maintain same nice 'table'
        +-----+------------------+-----+--------+--------+--------+--------+
        |  #  |       Date       |     |   Tim  |   Dan  |   Ann  | Samuel |
        +-----+------------------+-----+--------+--------+--------+--------+
        |   - | 23/02/2018 22:29 |     |   0.00 |   0.00 |   0.00 |   0.00 |
        +-----+------------------+-----+--------+--------+--------+--------+
        |   1 | 23/02/2018 22:29 |     |  50.00 |        |        |        |
        +-----+------------------+-----+--------+--------+--------+--------+
        |     |                  |     |  37.50 | -12.50 | -12.50 | -12.50 |
        +-----+------------------+-----+--------+--------+--------+--------+
        |     |                  |     |  37.50 | -12.50 | -12.50 | -12.50 |
        +-----+------------------+-----+--------+--------+--------+--------+
        |   2 | 23/02/2018 22:29 |     |        |  50.00 |        |        |
        +-----+------------------+-----+--------+--------+--------+--------+
        |     |                  |     | -12.50 |  37.50 | -12.50 | -12.50 |
        +-----+------------------+-----+--------+--------+--------+--------+
        |     |                  |     |  25.00 |  25.00 | -25.00 | -25.00 |
        +-----+------------------+-----+--------+--------+--------+--------+
        |   2 | 23/02/2018 22:29 |     | Samuel | Samuel | Samuel | Samuel |
        +-----+------------------+-----+--------+--------+--------+--------+
    '''
    '''
        Report - variant 2, 'text'

        Start
        Date/Time: 23/02/2018 22:29
        Balance:
        Tim: 0.00; Dan: 0.00; Ann: 0.00
        ###########################
        Transaction #: 1
        Date/Time: 23/02/2018 22:29
        Dan pays 500 for all
        Balance:
        Tim: -166.67; Dan: 333.33; Tim: -166.67
        ###########################
        Transaction #: 2
        Date/Time: 23/02/2018 22:29
        Tim pays 1000 for all
        Balance:
        Tim: 500.00; Dan: 0.00; Tim: -500.00
        ###########################
        Transaction #: Deleted
        Date/Time: 23/02/2018 22:29
        Tim pays 1000 for all
        Balance:
        Tim: 500.00; Dan: 0.00; Tim: -500.00
    '''

{
  'id': 'ee0c47cb-4823-4c06-a730-d85d9aa06c93',
  'lang': 'en',
  'sessionId': '9b843d91-391d-4bb3-b827-603e5312bbff',
  'timestamp': '2018-02-25T15:25:36.286Z',
  'originalRequest': {
    'data': {
      'update_id': 686221086,
      'message': {
        'message_id': 499,
        'text': '000000',
        'from': {
          'id': 178180819,
          'last_name': 'D.',
          'is_bot': False,
          'language_code': 'ru-RU',
          'first_name': 'Iurii'},
        'chat': {
          'id': 178180819,
          'last_name': 'D.',
          'type': 'private',
          'first_name': 'Iurii'
        },
        'date': 1519572336
      }
    },
    'source': 'telegram'
  }, 'result': {'metadata': {'webhookUsed': 'true', 'intentId': 'b0f482b9-2d3b-412a-8ad3-673ddfd1cf8c', 'webhookForSlotFillingUsed': 'false', 'intentName': 'test'}, 'source': 'agent', 'parameters': {}, 'speech': '', 'action': 'commonbalancebot-getjson', 'contexts': [{'name': 'generic', 'parameters': {'user.original': '', 'user': '', 'telegram_chat_id': '178180819'}, 'lifespan': 0}], 'score': 1.0, 'resolvedQuery': '000000', 'actionIncomplete': False, 'fulfillment': {'messages': [{'type': 0, 'speech': ''}], 'speech': ''}}, 'status': {'errorType': 'success', 'code': 200, 'webhookTimedOut': False}}




                          payload = {
                        "speech": "Welcome back, {}!\nContinuing with your log \"{}\". \nEnter \"open {}\" to switch to that another log".format(user_first_name, log_last_used, another_log),
                        "rich_messages": [
                            {
                                "platform": "telegram",
                                "type": 1,
                                "title": "Welcome back, {}!".format(user_first_name),
                                "subtitle": "Continuing with your log \"{}\"...\nBy the way you also have a log \"{}\".\nWhat should I do next?".format(log_last_used, another_log),
                                "buttons": [
                                    {
                                        "postback": "Open log {}".format(another_log),
                                        "text": "Switch to \"{}\"".format(another_log)
                                    },
                                    {
                                        "postback": "Add payment",
                                        "text": "Add payment"
                                    },
                                    {
                                        "postback": "Show balance",
                                        "text": "Show balance"
                                    },
                                    {
                                        "postback": "Help",
                                        "text": "Help"
                                    }
                                ]
                            }
                        ]
                    }


  ************


{
  'id': '5937af43-eda5-4ead-b770-2237f02efa8a',
  'result': {
    'source': 'agent',
    'score': 1.0,
    'contexts': [
      {
        'parameters': {
          'number.original': '',
          'number': '',
          'log_to_delete': 'kappa-wolf-020318',
          'log_to_delete.original': 'kappa-wolf-020318'
        },
        'lifespan': 1,
        'name': 'delete_log-followup'
      },
      {
        'parameters': {
          'number.original': '',
          'number': '',
          'log_to_delete':
          'kappa-wolf-020318',
          'log_to_delete.original': 'kappa-wolf-020318'
        },
        'lifespan': 3,
        'name': 'deletion_confirmed'
      },
      {
        'parameters': {
          'telegram_chat_id': '178180819',
          'number.original': '',
          'number': '',
          'log_to_delete': 'kappa-wolf-020318',
          'log_to_delete.original': 'kappa-wolf-020318'
        },
        'lifespan': 2,
        'name': 'generic'
      }
    ],
    'actionIncomplete': False,
    'action': 'commonbalancebot-delete_log-do_it',
    'fulfillment': {
      'messages': [
        {
          'type': 0,
          'platform': 'telegram',
          'speech': 'DELETE IT!'
        },
        {
          'type': 0,
          'speech': 'DELETE IT!'
        }
      ],
      'speech': 'DELETE IT!'
    },
    'resolvedQuery': 'kappa-wolf-020318',
    'parameters': {
      'number': '',
      'log_to_delete': 'kappa-wolf-020318'
    },
    'metadata': {
      'intentId': 'f4c8d97f-7be4-430a-add1-1386e1c7d198',
      'intentName': 'delete_log-confirmed',
      'webhookUsed': 'true',
      'webhookForSlotFillingUsed': 'false'
    },
    'speech': ''
  },


  'timestamp': '2018-03-02T09:49:16.015Z',
  'lang': 'en',
  'sessionId': '38338ff1-03bf-40d1-b6f7-948e9b1d365f',
  'originalRequest': {
    'source': 'telegram',
    'data': {
      'message': {
        'text': 'kappa-wolf-020318',
        'from': {
          'language_code': 'ru-RU',
          'last_name': 'D.',
          'is_bot': False,
          'id': 178180819,
          'first_name': 'Iurii'
        },
        'date': 1519984155,
        'chat': {
          'last_name': 'D.',
          'type': 'private',
          'id': 178180819,
          'first_name': 'Iurii'
        },
        'message_id': 673
      },
      'update_id': 686221185
    }
  },
  'status': {'code': 200, 'webhookTimedOut': False, 'errorType': 'success'}}

def delete_log(req):
    '''
        Function 'soft-deletes' log with mutual transactions:
        1) updates info in the 1st document in collection with log info
        2) inserts a document with log deletion data - see below
    '''
    # Response to be returned
    response = {"status": None, "payload": None}

    # 1. Get user id and log name from req
    creator_id = req_inside(req)["id"]

    collection_name = req["result"]["resolvedQuery"]

    # 2. Check if collection exists
    client = MongoClient()
    db = client.CBB
    if collection_name in db.collection_names(): # If such collection exists in general
        try: # If such collection exists for creator_id
            log_info = db[collection_name].find_one({"log": "info"})
            if log_info["creator_id"] != creator_id:
                response = {"status": "error", "payload": "You don't have a log named '{}'".format(collection_name)}
                return response
        except Exception as error:
            response = {"status": "error", "payload": "delete_log()-1: {}".format(error)}
            return response

        try: # If it exists but hasn't yet been deleted (inactivated)
            log_info = db[collection_name].find_one({"log": "info"})
            if log_info["log_status"] == "inactive":
                response = {"status": "error", "payload": "Log already deleted"}
                return response
        except Exception as error:
            response = {"status": "error", "payload": "delete_log()-2: {}".format(error)}
            return response

        try: # Try to delete (inactivate) it
            db[collection_name].update_one({"log": "info"}, {'$set': {"log_status": "inactive"}})
        except Exception as error:
            response = {"status": "error", "payload": "delete_log()-3: {}".format(error)}
            return response
    else:
        response = {"status": "error", "payload": "Log not found"}
        return response

    # 3. Prepare document to be inserted
    delete_log_action = {
        # '_id': 0, = creation date, used for sorting
        'creator_id': creator_id,
        'action_type': 'delete_log'
    }

    # 4. Insert document into DB
    try:
        delete_log_action_id =  db[collection_name].insert_one(delete_log_action).inserted_id
    except Exception as error:
        response = {"status": "error", "payload": error}
        return response

    # 5. Prepare final Ok response
    response = {"status": "ok", "payload": "Log {} was deleted".format(collection_name)}
    return response


{
  'speech': 'Log "zeta-rabbit-030318" successfully created, but at the moment contains only 1 user - you (Iurii) ;) \nTo continue please add users',
  'rich_messages': [
    {
      'type': 1, 'title': 'Log "zeta-rabbit-030318" successfully created!', 'platform': 'telegram', 'buttons': [{'postback': 'Add user', 'text': 'Add user'}, {'postback': 'Help', 'text': 'Help'}], 'subtitle': 'But at the moment it contains only 1 user - you (Iurii) ;) \nTo continue please add users :)'}
  ]
}


{
  'result': {
    'speech': '',
    'metadata': {
      'webhookForSlotFillingUsed': 'false',
      'webhookUsed': 'true',
      'intentId': 'fc1b540b-2357-4c28-b417-d98084ba1caf',
      'intentName': 'add_user'
    },
    'parameters': {
      'user': '',
      'given-name': 'Dan'
    },
    'contexts': [
      {
        'name': 'generic',
        'lifespan': 4,
        'parameters': {
          'user.original': '',
          'given-name.original': 'Dan',
          'user': '',
          'telegram_chat_id': '178180819',
          'given-name': 'Dan'
        }
      }
    ],
    'source': 'agent',
    'action': 'commonbalancebot-add_user',
    'fulfillment': {
      'speech': '',
      'messages': [
        {
          'speech': '',
          'type': 0
        }
      ]
    },
    'resolvedQuery': 'add user Dan',
    'score': 0.8999999761581421,
    'actionIncomplete': False
  },
  'lang': 'en',
  'id': '55b57e1e-31fa-4ba3-9abb-724745e8e2b5',
  'timestamp': '2018-03-03T20:23:02.55Z',
  'originalRequest': {
    'data': {
      'message': {
        'from': {
          'is_bot': False,
          'last_name': 'D.',
          'language_code': 'ru-RU',
          'id': 178180819,
          'first_name': 'Iurii'
        },
        'chat': {
          'first_name': 'Iurii', 'last_name': 'D.', 'type': 'private', 'id': 178180819
        },
        'message_id': 899,
        'text': 'add user Dan',
        'date': 1520108582
      },
      'update_id': 686221332
    },
    'source': 'telegram'
  },
  'sessionId': '3275c3e9-610e-47ef-a705-d247ed099ea0',
  'status': {
    'code': 200,
    'webhookTimedOut': False,
    'errorType': 'success'
  }
}


{
  'timestamp': '2018-03-03T21:47:31.645Z',
  'result': {
    'action': 'commonbalancebot-add_user', 'metadata': {'webhookUsed': 'true', 'webhookForSlotFillingUsed': 'false', 'intentId': 'fc1b540b-2357-4c28-b417-d98084ba1caf', 'intentName': 'add_user'},
    'parameters': {
      'user': 'Dan'
    }, 'fulfillment': {'speech': '', 'messages': [{'type': 0, 'speech': ''}]}, 'source': 'agent', 'actionIncomplete': False, 'contexts': [{'lifespan': 6, 'name': 'cookie', 'parameters': {'welcomed': 'yes', 'welcomed.original': '', 'user.original': 'Dan', 'user': 'Dan'}}, {'lifespan': 4, 'name': 'generic', 'parameters': {'telegram_chat_id': '178180819', 'user': 'Dan', 'user.original': 'Dan'}}], 'speech': '', 'score': 1.0, 'resolvedQuery': 'add user Dan'}, 'lang': 'en', 'originalRequest': {'source': 'telegram', 'data': {'update_id': 686221356, 'message': {'from': {'is_bot': False, 'first_name': 'Iurii', 'id': 178180819, 'language_code': 'ru-RU', 'last_name': 'D.'}, 'date': 1520113651, 'text': 'add user Dan', 'message_id': 931, 'chat': {'first_name': 'Iurii', 'type': 'private', 'id': 178180819, 'last_name': 'D.'}}}}, 'status': {'webhookTimedOut': False, 'code': 200, 'errorType': 'success'}, 'sessionId': '82f06b65-9c74-4ac2-b627-71465f633efb', 'id': 'edfea9aa-cd30-4e08-8da9-3adc66dbf03f'}


{
  'originalRequest': {
    'source': 'telegram',
    'data': {
      'message': {
        'date': 1520676018,
        'text': 'delete payment 5',
        'message_id': 1732,
        'chat': {
          'id': 178180819,
          'last_name': 'D.',
          'type': 'private',
          'first_name': 'Iurii'
        },
        'from': {
          'id': 178180819,
          'language_code': 'ru-RU',
          'last_name': 'D.',
          'first_name': 'Iurii',
          'is_bot': False
        }
      },
      'update_id': 686221788
    }
  },
  'timestamp': '2018-03-10T10:00:19.058Z',
  'lang': 'en',
  'status': {
    'code': 200,
    'errorType': 'success',
    'webhookTimedOut': False
  },
  'id': 'd9b23db8-36be-4113-a0b9-041004afca79',
  'sessionId': '0d600684-016b-4c3c-9b7a-f27151c366c4',
  'result': {
    'metadata': {
      'intentId': '347ac348-c667-45be-8dd7-34693f6ce66e',
      'webhookForSlotFillingUsed': 'false',
      'webhookUsed': 'true',
      'intentName': 'delete_payment'
    },
    'speech': '',
    'fulfillment': {
      'speech': '',
      'messages': [
        {
          'speech': '', 'type': 0
        }
      ]
    },
    'parameters': {
      'payment2delete': '5'
    },
    'score': 1.0,
    'resolvedQuery': 'delete payment 5',
    'contexts': [
      {
        'parameters': {
          'payment2delete.original': '5',
          'telegram_chat_id': '178180819',
          'payment2delete': '5'
        },
        'lifespan': 4,
        'name': 'generic'
      }
    ],
    'source': 'agent',
    'actionIncomplete': False,
    'action': 'commonbalancebot-delete_payment'
  }
}